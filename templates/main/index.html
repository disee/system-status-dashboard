{% extends "base/base.html" %}

{% comment %}

 Copyright 2013 - Tom Alessi

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and 
 limitations under the License.

{% endcomment %}

{% block content %}

<script type="text/javascript">

   // Date
   $(function() {
      $("#jump_to").datepicker({dateFormat: 'yy-mm-dd'});
   });

</script>

<div class="row">
  <div class="large-11 columns">
    <p>{{information|safe}}</p>
  </div>
</div>

<div class="spacer_small"></div>

{% if alert %}
<div class="row">
  <div class="large-10 large-centered columns">
    <div class="panel callout radius" style="background: #D45757;">
      {{alert}}
    </div>
  </div>
</div>
{% endif %}

<div class="row">
  <div class="large-6 columns">
    <font class="heading">System Status as of {% now "Y-m-d H:i:s e" %}:</font><br><br>
  </div>
</div>

<div class="row">
  <div class="large-12 large-centered columns">
    <table class="responsive">
     {% for row in data %}
       {% if forloop.first %}
         <tr>
          {% for heading in row %}
           {% if forloop.first %}
            <th style="min-width: 200px;">{{heading}}</th>
           {% else %}
            <th style="min-width: 100px;">{{heading|date:"Y-m-d"}}<br>{{heading|date:"D"}}</th>
           {% endif %}
          {% endfor %}
         </tr>
       {% else %}
        <tr>
         {% for column in row %}
           
           {# Set the status colors next to the service and print the service #}
           {% if forloop.first %}
             <td>
             {% if column.status == 1 %}
             <img src="/html/images/incident_red.png">
             {% else %}
              {% if column.status == 2 %}
               <img src="/html/images/incident_blue.png">
              {% else %}
               <img src="/html/images/incident_green.png">
              {% endif %}
             {% endif %}
             {{column.service}}
             </td>
           {% else %}

             {# Check each date #}
             <td style="text-align:center;">
             {% for event in column %}
               {% if not event == 'green' %}
                 {# We have some events to show #}
                 {# See if we have a maintenance or an incident #}

                 {% if event.type == 1 %}
                   {% if event.status == 1 %}
                     <a href="/i_detail?id={{event.id}}"><img src="/html/images/incident_red.png" title="ID: {{event.id}} : {{event.open|date:"Y-m-d H:i:s"}} ~"></a>
                   {% else %}
                     <a href="/i_detail?id={{event.id}}"><img src="/html/images/incident_orange.png" title="ID: {{event.id}} : {{event.open|date:"Y-m-d H:i:s"}} ~ {{event.closed|date:"Y-m-d H:i:s"}}"></a>
                   {% endif %}
                 {% else %}
                   {% if event.type == 2 %}
                     <a href="/m_detail?id={{event.id}}"><img src="/html/images/incident_blue.png" title="ID: {{event.id}} : {{event.open|date:"Y-m-d H:i:s"}} ~ {{event.closed|date:"Y-m-d H:i:s"}}"></a>
                   {% endif %}
                 {% endif %}
               {% endif %}

             {% endfor %}
             </td>
           {% endif %}
         {% endfor %}
        </tr>
       {% endif %}
     {% endfor %}

         <tr>
          <td class="td_border_top">
            {% if backward_link %}
            <a href="{{backward_link}}"><<< older</a>
            {% endif %}

            {% if forward_link %}
            <a href="{{forward_link}}">newer >>></a>
            {% endif %}
          </td>
          <td class="td_border_top" style="text-align: right; font-size: 12px;"><b>Key:</b></td>
          <td class="td_border_top" colspan="6" style="min-width: 600px; font-size: 12px;">
            <img src="/html/images/incident_green.png">&nbsp;Service Normal
            &nbsp;&nbsp;
            <img src="/html/images/incident_red.png">&nbsp;Service Disruption
            &nbsp;&nbsp;
            <img src="/html/images/incident_orange.png">&nbsp;Service Disruption (resolved)
            &nbsp;&nbsp;
            <img src="/html/images/incident_blue.png">&nbsp;Planned Maintenance
          </td>
        </tr>
    </table>
  </div>
</div>

<div class="row">
  <div class="large-11 columns">
    <form name="prefs_jump" action="/prefs/jump" method="post">
     {% csrf_token %}
    <input type="text" class="jump_to" name="jump_to" id="jump_to" placeholder="Jump to date" onchange='this.form.submit()'/>
    </form>
  </div>
</div>

<div class="row">
  <div class="large-11 columns">
    <br><br><br>
    <font class="heading">Detailed Service Disruption Timeline:</font><hr>
    <p>
    {% if incident_timeline %}
      {% for row in incident_timeline %}
       {{row.event_time__start|date:"Y-m-d H:i:s e"}} - {{row.event_description__description}} <a href="/i_detail?id={{row.id}}">more detail...</a><br>
      {% endfor %}
    {% else %}
      <font class="all_good">No current service disruptions.</font>
    {% endif %}
    </p>
  </div>
</div>

<div class="row">
  <div class="large-11 columns">
    <br><br><br>
    <font class="heading">Detailed Maintenance Timeline:</font><hr>
    <p>
    {% if maintenance_timeline %}
      {% for row in maintenance_timeline %}
       {{row.event_time__start|date:"Y-m-d H:i:s e"}} - {{row.event_description__description}} <a href="/m_detail?id={{row.id}}">more detail...</a><br>
      {% endfor %}
    {% else %}
      <font class="all_good">No planned maintenance is occurring.</font>
    {% endif %}
    </p>  
  </div>
</div>

<div class="row">
  <div class="large-11 columns">
    <br><br><br>
    <font class="heading">Historical Summary Status:</font><hr>
  </div>
</div>

{% if show_graph %}
<script type="text/javascript">
$(function () {
        
        $('#graph').highcharts({
            credits: {
              enabled: false
            },
            chart: {
                type: 'spline',
                marginRight: 25,
                marginBottom: 75,
                height: 250,
                width: 900
            },
            plotOptions: {
                spline: {
                    marker: {
                        enabled: true
                    }
                }
            },
            title: {
                text: ' ',
                x: -20, //center
                style: {
                  color: '#616161',
                  fontSize: '16px'
                }
            },
            xAxis: {
                categories: [{% for row in count_data %}{% if forloop.last %}'{{row.date}}'{% else %}'{{row.date}}',{% endif %}{% endfor %}],
                labels: {
                    rotation: 290,
                    x: -5,
                    y: 35,
                    step: 2
                },
            },
            yAxis: {
                title: {
                    text: 'Event Counts'
                },
                allowDecimals: false,
                //min: 0
            },
            legend: {
                enabled: true,
                verticalAlign: 'top',
                align: 'right',
                x: -25
            },
            series: [{
                name: 'Disruptions',
                data: [
     
                  {% for row in count_data %}
                    {% if forloop.last %}
                    {
                      y: {{row.incidents}},
                      events: {
                        click: function() {
                          window.open('/igsearch?date={{row.date}}');
                        }
                      }
                    }
                    {% else %}
                    {  
                      y: {{row.incidents}},
                      events: {
                        click: function() {
                          window.open('/igsearch?date={{row.date}}');
                        }
                      }
                    },
                    {% endif %}
                  {% endfor %}
                
                ],
                color: '#FDBE08'
            }, {
                name: 'Maintenance',
                data: [{% for row in count_data %}{% if forloop.last %}{{row.maintenances}}{% else %}{{row.maintenances}},{% endif %}{% endfor %}],
                color: '#4F84D1'
            }]
        });
});
</script>
<script type="text/javascript" src="/html/js/highcharts.js"></script>
<div class="row left hide-for-small">
  <div class="large-12 columns">
    <div id="graph" style="width: 905px;"></div>
    <br><br>
  </div>
</div>
{% else %}
<p><font class="all_good">No incidents or maintenance have occurred in the past 30 days and no maintenance is planned for the next 30 days.</font></p><br><br>
{% endif %}

{% endblock %}
