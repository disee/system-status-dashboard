{% extends "base/base.html" %}

{% comment %}

 Copyright 2013 - Tom Alessi

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and 
 limitations under the License.

{% endcomment %}

{% block content %}

<script type="text/javascript">

   // Jump To
   $(function() {
      $("#jump_to").datepicker({dateFormat: 'yy-mm-dd'});
   });

</script>

{# This is row consisting of 12 columns that will display all messages passed in the request #}
{% include "admin/messages.html" %}

{% if alert %}
<div class="row">
  <div class="large-12 large-centered columns">
    <div class="panel callout radius" style="background: #D45757;">
      {{alert}}
    </div>
  </div>
</div>
{% endif %}

{% if information %}
<div class="row">
  <div class="large-12 columns">
    <p>{{information|safe}}</p>
  </div>
</div>
{% endif %}

<div class="spacer_small"></div>

<div class="row">
  <div class="large-6 columns">
    <font class="heading">System Status as of {% now "Y-m-d H:i:s e" %}:</font><br><br>
  </div>
</div>

<div class="row">
  <div class="large-6 columns">
    <a href="{{backward_link}}" title="Move back one week"><span class="genericon genericon-rewind genericon_container_nav"></span></a>
    &nbsp;&nbsp;
    <a href="{{forward_link}}" title="Move forward one week"><span class="genericon genericon-fastforward genericon_container_nav"></span></a>
    &nbsp;&nbsp;
    <span id="calselector" class="genericon genericon-day genericon_container_nav" title="Jump to a specific date"></span>

    &nbsp;&nbsp;
    <a href="#" data-dropdown="keydrop"><span class="genericon genericon-key genericon_container_nav" title="Dashboard color indicator key"></span></a>

    <div id="keydrop" class="f-dropdown content" data-dropdown-content>
      <div>
        <h5>Dashboard Key</h5>
        <div class="spacer_small"></div>
      </div>
      <div>
        <span class="legend"><img src="/html/images/incident_green.png">&nbsp;Service Normal - the service is operating normally.</span>
        <div class="spacer_small"></div>
      </div>
      <div>
        <span class="legend"><img src="/html/images/incident_red.png">&nbsp;Service Disruption - the service is experiencing an active disruption.</span>
        <div class="spacer_small"></div>      
      </div>
      <div>
        <span class="legend"><img src="/html/images/incident_orange.png">&nbsp;Service Disruption (resolved) - a service disruption occurred, but has been resolved.</span>
        <div class="spacer_small"></div>
      </div>
      <div>
        <span class="legend"><img src="/html/images/incident_blue.png">&nbsp;Planned Maintenance - planned maintenance is occurring with the service.</span>
      </div>
    </div>

    <form name="prefs_jump" action="/prefs/jump" method="post">
    {% csrf_token %}
      <input type="text" class="jump_to" name="jump_to" id="jump_to" onchange='this.form.submit()'/>
    </form>

  </div>
</div>

<script>
  // Interact with datepicker through genericon icon
  $("#calselector").click(function() {
      $("#jump_to").datepicker('show');
  });
</script>

<div class="row">
  <div class="large-12 large-centered columns">
    <table class="responsive">
     {% for row in data %}
       {% if forloop.first %}
         <tr>
          {% for heading in row %}
           {% if forloop.first %}
            <th style="width: 200px;">{{heading}}</th>
           {% else %}
            <th style="width: 100px;">{{heading|date:"Y-m-d"}}<br>{{heading|date:"D"}}</th>
           {% endif %}
          {% endfor %}
         </tr>
       {% else %}
        <tr>
         {% for column in row %}
           
           {# Set the status colors next to the service and print the service #}
           {# 1 is active incident and 2 is active maintenance #}
           {% if forloop.first %}
             <td style="width: 200px;">
              <div>
                <div style="display: inline-block; vertical-align: middle; text-align: center;">
                   {% if column.status == 1 %}
                     <span><img src="/html/images/incident_red.png"></span>
                   {% else %}
                    {% if column.status == 2 %}
                     <span><img src="/html/images/incident_blue.png"></span>
                    {% else %}
                     <span><img src="/html/images/incident_green.png"></span>
                    {% endif %}
                   {% endif %}
                </div>
                <span>
                  &nbsp;&nbsp;{{column.service}}
                </span>
              </div>
             </td>
           {% else %}

             {# Check each date #}
             <td style="width: 100px;">
             {% for event in column %}
               {% if not event == 'green' %}
                 {# We have some events to show #}
                 {# See if we have a maintenance or an incident #}

                 {% if event.type == 'incident' %}
                   {% if event.status == 'open' %}
                     <a href="/i_detail?id={{event.id}}"><img src="/html/images/incident_red.png" title="Service Disruption (ID:{{event.id}}) {{event.open|date:"Y-m-d H:i:s e"}} ~"></a>
                   {% else %}
                     <a href="/i_detail?id={{event.id}}"><img src="/html/images/incident_orange.png" title="Resolved Service Disruption (ID:{{event.id}}) {{event.open|date:"Y-m-d H:i:s e"}} ~ {{event.closed|date:"Y-m-d H:i:s e"}}"></a>
                   {% endif %}
                 {% else %}
                   {% if event.type == 'maintenance' %}
                     <a href="/m_detail?id={{event.id}}"><img src="/html/images/incident_blue.png" title="Planned Maintenance (ID:{{event.id}}) {{event.open|date:"Y-m-d H:i:s e"}} ~ {{event.closed|date:"Y-m-d H:i:s e"}}"></a>
                   {% endif %}
                 {% endif %}
               {% endif %}

             {% endfor %}
             </td>
           {% endif %}
         {% endfor %}
        </tr>
       {% endif %}
     {% endfor %}
    </table>
  </div>
</div>

<div class="row">
  <div class="large-12 columns">
    <br><br><br>
    <font class="heading">Detailed Service Disruption Timeline:</font><div class="hr"></div>
    <p>
    {% if incident_timeline %}
      {% for row in incident_timeline %}
       {{row.start|date:"Y-m-d H:i:s e"}} - {{row.description}} <a href="/i_detail?id={{row.id}}">more detail...</a><br>
      {% endfor %}
    {% else %}
      <font class="all_good">No current service disruptions.</font>
    {% endif %}
    </p>
  </div>
</div>

<div class="row">
  <div class="large-12 columns">
    <br><br><br>
    <font class="heading">Detailed Maintenance Timeline:</font><div class="hr"></div>
    <p>
    {% if maintenance_timeline %}
      {% for row in maintenance_timeline %}
       {{row.start|date:"Y-m-d H:i:s e"}} - {{row.description}} <a href="/m_detail?id={{row.id}}">more detail...</a><br>
      {% endfor %}
    {% else %}
      <font class="all_good">No planned maintenance is occurring.</font>
    {% endif %}
    </p>  
  </div>
</div>

<div class="row">
  <div class="large-12 columns">
    <br><br><br>
    <font class="heading">Historical Summary Status:</font>&nbsp;
    <span data-tooltip class="has-tip tip-bottom" title="Historical summary status shows the past 30 days (incidents and maintenance) and future 30 days (scheduled maintenance).  Click on any of the event indicators to review detailed information about events.  Remove a data series from the graph by clicking its legend icon."><span class="genericon genericon-help"></span></span>
    <div class="hr"></div>
  </div>
</div>

{% if show_graph %}
<script type="text/javascript">
$(function () {
        
        $('#graph').highcharts({
            credits: {
              enabled: false
            },
            chart: {
                type: 'spline',
                marginRight: 25,
                marginBottom: 75,
                height: 250,
                width: 900
            },
            plotOptions: {
                spline: {
                    marker: {
                        enabled: true
                    }
                }
            },
            title: {
                text: ' ',
                x: -20, //center
                style: {
                  color: '#616161',
                  fontSize: '16px'
                }
            },
            xAxis: {
                categories: [{% for row in count_data %}{% if forloop.last %}'{{row.date}}'{% else %}'{{row.date}}',{% endif %}{% endfor %}],
                labels: {
                    rotation: 290,
                    x: -5,
                    y: 35,
                    step: 2
                },
            },
            yAxis: {
                title: {
                    text: 'Event Counts'
                },
                allowDecimals: false,
                //min: 0
            },
            legend: {
                enabled: true,
                verticalAlign: 'top',
                align: 'right',
                x: -25
            },
            series: [{
                name: 'Disruptions',
                data: [
     
                  {% for row in count_data %}
                    {% if forloop.last %}
                    {
                      y: {{row.incidents}},
                      events: {
                        click: function() {
                          window.open('/gsearch?date={{row.date}}&type=incident', '_self');
                        }
                      }
                    }
                    {% else %}
                    {  
                      y: {{row.incidents}},
                      events: {
                        click: function() {
                          window.open('/gsearch?date={{row.date}}&type=incident', '_self');
                        }
                      }
                    },
                    {% endif %}
                  {% endfor %}
                
                ],
                color: '#FDBE08'
            }, {
                name: 'Maintenance',
                data: [

                  {% for row in count_data %}
                    {% if forloop.last %}
                    {
                      y: {{row.maintenances}},
                      events: {
                        click: function() {
                          window.open('/gsearch?date={{row.date}}&type=maintenance', '_self');
                        }
                      }
                    }
                    {% else %}
                    {  
                      y: {{row.maintenances}},
                      events: {
                        click: function() {
                          window.open('/gsearch?date={{row.date}}&type=maintenance', '_self');
                        }
                      }
                    },
                    {% endif %}
                  {% endfor %}

                ],
                color: '#4F84D1'
            }]
        });
});
</script>
<script type="text/javascript" src="/html/js/highcharts.js"></script>

<div class="row hide-for-small">
  <div class="large-12 columns">
    <div id="graph" style="width: 905px;"></div>
    <br><br>
  </div>
</div>

{% else %}
<div class="row">
  <div class="large-12 columns">
    <p><font class="all_good">No incidents or maintenance have occurred in the past 30 days and no maintenance is planned for the next 30 days.</font></p><br><br>
  </div>
</div>
{% endif %}

{% endblock %}
