{% extends "base/base.html" %}

{% comment %}

 Copyright 2013 - Tom Alessi

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and 
 limitations under the License.

{% endcomment %}

{% block content %}

{# This is row consisting of 12 columns that will display all messages passed in the request #}
{% include "admin/messages.html" %}

{% if alert %}
<div class="row">
  <div class="large-12 large-centered columns">
    <div class="panel callout radius" style="background: #D45757;">
      {{alert}}
    </div>
  </div>
</div>
{% endif %}

{% if information %}
<div class="row">
  <div class="large-12 columns">
    <p>{{information|safe}}</p>
  </div>
</div>
{% endif %}

<div class="spacer_small"></div>

<div class="row">
  <div class="large-6 columns">
    <span class="heading">System Status as of {% now "Y-m-d H:i:s e" %}:</span><br><br>
  </div>
</div>

<div class="row">
  <div class="large-6 columns">
    <a href="{{backward_link}}" title="Move back one week"><span class="foundicon-gen-left-arrow foundicon_container_nav"></span></a>
    &nbsp;&nbsp;
    <a href="{{forward_link}}" title="Move forward one week"><span class="foundicon-gen-right-arrow foundicon_container_nav"></span></a>
    &nbsp;&nbsp;
    <span id="calselector" title="Jump to a specific date" class="foundicon-gen-calendar foundicon_container_nav"></span>
    &nbsp;&nbsp;
    <a href="#" data-dropdown="keydrop"><span class="foundicon-acc-key foundicon_container_nav" title="Dashboard color indicator key"></span></a>

    <div id="keydrop" class="f-dropdown content keydrop" data-dropdown-content>
      <div>
        <h5>Dashboard Key</h5>
        <div class="spacer_small"></div>
      </div>
      <div>
        <span class="legend"><span class="foundicon-genenc-checkmark foundicon_container_green"></span>&nbsp;Service Normal - the service is operating normally.</span>
        <div class="spacer_small"></div>
      </div>
      <div>
        <span class="legend"><span class="foundicon-genenc-remove foundicon_container_red"></span>&nbsp;Service Disruption - the service is experiencing an active disruption.</span>
        <div class="spacer_small"></div>      
      </div>
      <div>
        <span class="legend"><span class="foundicon-genenc-remove foundicon_container_orange"></span>&nbsp;Service Disruption (resolved) - a service disruption occurred, but has been resolved.</span>
        <div class="spacer_small"></div>
      </div>
      <div>
        <span class="legend"><span class="foundicon-genenc-tools foundicon_container_blue"></span>&nbsp;Planned Maintenance - planned maintenance is occurring with the service.</span>
      </div>
    </div>

    <form name="prefs_jump" action="/prefs/jump" method="post" style="margin: 0;">
    {% csrf_token %}
      <input type="text" class="jump_to" name="jump_to" id="jump_to" onchange='this.form.submit()'/>
    </form>

  </div>
</div>

<script>
  // Interact with datepicker through foundicon icon
  $("#calselector").click(function() {
      $("#jump_to").datepicker('show');
  });
</script>

<div class="row">
  <div class="large-12 large-centered columns">
    <table class="responsive">
     {% for row in data %}
       {% if forloop.counter == 1 %}
         <tr>
          {% for heading in row %}
           {% if forloop.counter == 1 %}
            <th style="width: 50px;">{{heading}}</th>
           {% else %}
            {% if forloop.counter == 2 %}
              <th style="width: 220px;">{{heading}}</th>
            {% else %}
              <th style="width: 100px;">{{heading|date:"Y-m-d"}}<br>{{heading|date:"D"}}</th>
            {% endif %}
           {% endif %}
          {% endfor %}
         </tr>
       {% else %}
        <tr>
         {% for column in row %}
           {# Set the status colors next to the service and print the service #}
           {# 1 is active incident and 2 is active maintenance #}
           {% if forloop.counter == 1 %}
             <td style="text-align: center;">
               {% if column.status == 1 %}
                 <span class="foundicon-genenc-remove foundicon_container_red" title="A service disruption is currently occurring with this service."></span>
               {% else %}
                {% if column.status == 2 %}
                 <span class="foundicon-genenc-tools foundicon_container_blue" title="Maintenance is currently occurring with this service."></span>
                {% else %}
                  <span class="foundicon-genenc-checkmark foundicon_container_green" title="Service is operating normally."></span>
                {% endif %}
               {% endif %}
              </td>
              <td>
                <span>{{column.service}}</span>
              </td>
           {% else %}
             {# Check each date #}
             <td>
             {% for event in column %}
               {% if not event == 'green' %}
                {# We have some events to show #}
                {# See if we have a maintenance or an incident #}
                {% if event.type == 'incident' %}
                   {% if event.status == 'open' %}
                    <a href="#" data-dropdown="idrop_{{event.id}}">
                      <span class="foundicon-genenc-remove foundicon_container_red" title="Service Disruption (ID:{{event.id}}) {{event.open|date:"Y-m-d H:i:s e"}} ~"></span>
                    </a>
                    <div id="idrop_{{event.id}}" class="f-dropdown content edrop" data-dropdown-content>
                      <span class="dashboard_drop">
                        <h5>Incident Information</h5>
                        <br>Start: {{event.open|date:"Y-m-d H:i:s e"}}<br><br>{{event.description}}
                        <br><br>
                        <a href="/i_detail?id={{event.id}}" title="More information">Full Details</a>
                      </span>
                    </div>
                   {% else %}
                    <a href="#" data-dropdown="irdrop_{{event.id}}">
                      <span class="foundicon-genenc-remove foundicon_container_orange" title="Resolved Service Disruption (ID:{{event.id}}) {{event.open|date:"Y-m-d H:i:s e"}} ~ {{event.closed|date:"Y-m-d H:i:s e"}}"></span>
                    </a>
                    <div id="irdrop_{{event.id}}" class="f-dropdown content edrop" data-dropdown-content>
                      <span class="dashboard_drop">
                        <h5>Incident (Resolved) Information</h5>
                        <br>Start: {{event.open|date:"Y-m-d H:i:s e"}}<br><br>{{event.description}}
                        <br><br>
                        <a href="/i_detail?id={{event.id}}" title="More information">Full Details</span></a>
                      </span>
                    </div>
                   {% endif %}
                {% else %}
                  {% if event.type == 'maintenance' %}
                    <a href="#" data-dropdown="mdrop_{{event.id}}">
                      <span class="foundicon-genenc-tools foundicon_container_blue" title="Planned Maintenance (ID:{{event.id}}) {{event.open|date:"Y-m-d H:i:s e"}} ~ {{event.closed|date:"Y-m-d H:i:s e"}}"></span>
                    </a>
                    <div id="mdrop_{{event.id}}" class="f-dropdown content edrop" data-dropdown-content>
                      <span class="dashboard_drop">
                        <h5>Maintenance Information</h5>
                        <br>Start: {{event.open|date:"Y-m-d H:i:s e"}}<br><br>{{event.description}}
                        <br><br>
                        <a href="/m_detail?id={{event.id}}" title="More information">Full Details</a>
                      </span>
                    </div>
                  {% endif %}
                {% endif %}
               {% endif %}
             {% endfor %}
             </td>
           {% endif %} 
         {% endfor %}
        </tr>
       {% endif %}
     {% endfor %}
    </table>
  </div>
</div>

<div class="row">
  <div class="large-12 columns">
    <br><br><br>
    <span class="heading">Active Service Disruption Timeline:</span><div class="hr"></div>
    {% if incident_timeline %}
      {% for row in incident_timeline %}
       <span class="timeline">
        <a href="/i_detail?id={{row.id}}">{{row.start|date:"Y-m-d H:i:s e"}}</a>
         - {{row.description}}
        </span>
       <br>
      {% endfor %}
    {% else %}
      <span class="all_good">No current service disruptions.</span>
    {% endif %}
  </div>
</div>

<div class="row">
  <div class="large-12 columns">
    <br><br><br>
    <span class="heading">Active Maintenance Timeline:</span><div class="hr"></div>
    {% if maintenance_timeline %}
      {% for row in maintenance_timeline %}
       <span class="timeline">
        <a href="/m_detail?id={{row.id}}">{{row.start|date:"Y-m-d H:i:s e"}}</a>
        - {{row.description}}
       </span>
       <br>
      {% endfor %}
    {% else %}
      <span class="all_good">No planned maintenance is occurring.</span>
    {% endif %}
  </div>
</div>

<div class="row">
  <div class="large-12 columns">
    <br><br><br>
    <span class="heading">Summary Status:</span>
    <a href="#" data-dropdown="histsumdrop"><span class="foundicon-acc-key foundicon_container_key" title="Summary Status Key"></a>
    <div id="histsumdrop" class="f-dropdown content histsumdrop" data-dropdown-content>
      <h5>Historical Summary Status</h5><br>
      <span class="help_drop">
        Historical summary status shows the past 30 days (incidents and maintenance) and future 30 days (scheduled maintenance).<br><br>Click on any of the event indicators to review detailed information about events.<br><br>Remove a data series from the graph by clicking its legend icon.
      </span>
    </div>
    <div class="hr"></div>
  </div>
</div>

{% if show_graph %}
<script type="text/javascript">
$(function () {
        
        $('#graph').highcharts({
            credits: {
              enabled: false
            },
            chart: {
                type: 'spline',
                marginRight: 25,
                marginBottom: 75,
                height: 250,
                /* width: 900, */
                backgroundColor: '#f9f9f9',
                borderColor: '#cccccc',
                borderWidth: 1
            },
            plotOptions: {
                spline: {
                    marker: {
                        enabled: true
                    }
                }
            },
            title: {
                text: ' ',
                x: -20, //center
                style: {
                  color: '#616161',
                  fontSize: '16px'
                }
            },
            xAxis: {
                categories: [{% for row in count_data %}{% if forloop.last %}'{{row.date}}'{% else %}'{{row.date}}',{% endif %}{% endfor %}],
                labels: {
                    rotation: 290,
                    x: -5,
                    y: 35,
                    step: 2
                },
            },
            yAxis: {
                title: {
                    text: 'Event Counts'
                },
                allowDecimals: false,
                gridLineColor: '#eeeeee'
                //min: 0
            },
            legend: {
                enabled: true,
                verticalAlign: 'top',
                align: 'right',
                x: -25
            },
            series: [{
                name: 'Disruptions',
                data: [
     
                  {% for row in count_data %}
                    {% if forloop.last %}
                    {
                      y: {{row.incidents}},
                      events: {
                        click: function() {
                          window.open('/gsearch?date={{row.date}}&type=incident', '_self');
                        }
                      }
                    }
                    {% else %}
                    {  
                      y: {{row.incidents}},
                      events: {
                        click: function() {
                          window.open('/gsearch?date={{row.date}}&type=incident', '_self');
                        }
                      }
                    },
                    {% endif %}
                  {% endfor %}
                
                ],
                color: '#FDBE08'
            }, {
                name: 'Maintenance',
                data: [

                  {% for row in count_data %}
                    {% if forloop.last %}
                    {
                      y: {{row.maintenances}},
                      events: {
                        click: function() {
                          window.open('/gsearch?date={{row.date}}&type=maintenance', '_self');
                        }
                      }
                    }
                    {% else %}
                    {  
                      y: {{row.maintenances}},
                      events: {
                        click: function() {
                          window.open('/gsearch?date={{row.date}}&type=maintenance', '_self');
                        }
                      }
                    },
                    {% endif %}
                  {% endfor %}

                ],
                color: '#4F84D1'
            }]
        });
});
</script>
<script type="text/javascript" src="/html/js/highcharts.js"></script>

<div class="row">
  <div class="large-12 columns">
    <div id="graph"></div>
    <br><br>
  </div>
</div>

{% else %}
<div class="row">
  <div class="large-12 columns">
    <span class="all_good">No incidents or maintenance have occurred in the past 30 days and no maintenance is planned for the next 30 days.</span><br><br>
  </div>
</div>
{% endif %}


<script type="text/javascript">

   // Jump To
   $(function() {
      $("#jump_to").datepicker({dateFormat: 'yy-mm-dd'});
   });

</script>

{% endblock %}
